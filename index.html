<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>서비스기획팀</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #222;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow: hidden;
    }
    .kakao-window {
      position: relative;
      width: 520px;
      height: min(760px, 94vh);
      background: #dfe3eb;
      border-radius: 10px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid #aaa;
    }

    /* 상단 영역 */
    .kakao-header {
      height: 50px;
      background: linear-gradient(to bottom, #f4f4f4, #dfdfdf);
      border-bottom: 1px solid #c2c2c2;
      display: flex;
      align-items: center;
      padding: 0 16px;
      color: #222;
    }
    .kakao-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }
    .profile-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      overflow: hidden;
      background: #bbb;
      flex-shrink: 0;
    }
    .profile-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .chat-title {
      font-size: 14px;
      font-weight: 600;
    }
    .member-count {
      font-size: 12px;
      color: #666;
      margin-left: 4px;
    }
    .kakao-header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: #666;
    }

    /* 채팅 영역 */
    .chat-body {
      flex: 1;
      background: #b8c3d1;
      padding: 12px 12px 6px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      max-width: 100%;
    }
    .msg-row.left {
      justify-content: flex-start;
    }
    .msg-row.right {
      justify-content: flex-end;
    }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .msg-content {
      max-width: 75%;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .nickname {
      font-size: 11px;
      color: #333;
      margin-left: 4px;
    }
    .bubble {
      padding: 7px 9px;
      border-radius: 4px;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .bubble.villain {
      background: #f0f5fb;
      border: 1px solid #a9b9d5;
    }
    .bubble.me {
      background: #ffe96b;
      border: 1px solid #e0c542;
    }
    .time {
      font-size: 10px;
      color: #555;
      margin: 0 4px;
      white-space: nowrap;
    }
    .msg-row.left .time { order: 3; }
    .msg-row.right .time { order: -1; }

    .system-msg {
      align-self: center;
      font-size: 11px;
      color: #555;
      background: rgba(0,0,0,0.1);
      padding: 4px 8px;
      border-radius: 10px;
      margin: 6px 0;
    }

    /* 하단 입력 + 톤 선택 영역 */
    .input-bar {
      background: #f0f1f4;
      border-top: 1px solid #c2c5d0;
      padding: 6px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .tone-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #555;
    }
    .tone-row select {
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 4px;
      border: 1px solid #c2c5d0;
      background: #fff;
    }
    .input-main {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    .input-main textarea {
      flex: 1;
      resize: none;
      min-height: 50px;
      max-height: 140px;
      border-radius: 4px;
      border: 1px solid #c2c5d0;
      font-size: 13px;
      padding: 6px 8px;
    }
    .input-main button {
      width: 72px;
      height: 44px;
      border-radius: 4px;
      border: 1px solid #c2c5d0;
      background: #f8f9fb;
      font-size: 12px;
      cursor: pointer;
    }

    /* 교정 팝업 */
    .suggestion-popup {
      position: absolute;
      bottom: 130px; /* 입력창 바로 위 */
      left: 50%;
      transform: translateX(-50%);
      width: 380px;
      max-width: calc(100% - 40px);
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.35);
      border: 1px solid #e5e7eb;
      display: none;
      z-index: 20;
      overflow: hidden;
    }
    .suggestion-header {
      background: linear-gradient(90deg, #7c3aed, #ec4899);
      color: #ffffff;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
    }
    .suggestion-header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .suggestion-title {
      font-size: 12px;
      font-weight: 600;
    }
    .suggestion-sub {
      font-size: 10px;
      opacity: 0.9;
    }
    .suggestion-close {
      cursor: pointer;
      font-size: 14px;
      opacity: 0.9;
    }
    .suggestion-body {
      padding: 10px 12px;
      background: #f9fafb;
    }
    .suggestion-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .suggestion-item {
      padding: 8px 10px;
      border-radius: 8px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      line-height: 1.5;
      cursor: pointer;
    }
    .suggestion-item:hover {
      border-color: #7c3aed;
      box-shadow: 0 0 0 1px rgba(124,58,237,0.2);
    }
    .suggestion-footer {
      margin-top: 8px;
      font-size: 10px;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* API 키 모달 */
    .apikey-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .apikey-modal {
      width: 360px;
      max-width: calc(100% - 40px);
      border-radius: 16px;
      background: #ffffff;
      box-shadow: 0 18px 40px rgba(15,23,42,0.45);
      padding: 18px 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .apikey-title {
      font-size: 16px;
      font-weight: 600;
    }
    .apikey-desc {
      font-size: 12px;
      color: #4b5563;
    }
    .apikey-input {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 13px;
      width: 100%;
    }
    .apikey-footer {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #6b7280;
    }
    .apikey-button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(90deg,#6366f1,#ec4899);
      color: #ffffff;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- API 키 입력 모달 -->
  <div id="apikeyOverlay" class="apikey-overlay">
    <div class="apikey-modal">
      <div class="apikey-title">OpenAI API 키 입력</div>
      <div class="apikey-desc">
        이 프로토타입은 OpenAI API를 사용합니다.<br />
        <b>sk-</b>로 시작하는 개인 키를 입력하셔야 테스트 가능합니다.<br />
        (키는 브라우저에만 저장되며 서버로 전송되지 않습니다.)
      </div>
      <input
        id="apikeyInput"
        class="apikey-input"
        type="password"
        placeholder="sk-로 시작하는 API 키"
      />
      <div class="apikey-footer">
        <span>팀 내부 테스트용으로만 사용해주세요.</span>
        <button id="apikeyButton" class="apikey-button">입장하기</button>
      </div>
    </div>
  </div>

  <div class="kakao-window">

    <!-- HEADER -->
    <div class="kakao-header">
      <div class="kakao-header-left">
        <div class="profile-circle">
          <img src="logo.png" alt="로고" />
        </div>
        <div class="chat-title">서비스기획팀</div>
        <div class="member-count">5</div>
      </div>

    </div>

    <!-- 교정 팝업 -->
    <div id="suggestionPopup" class="suggestion-popup">
      <div class="suggestion-header">
        <div class="suggestion-header-left">
          <div class="suggestion-title">LinguaOS</div>
          <div id="suggestionToneLabel" class="suggestion-sub">톤: 기본</div>
        </div>
        <div id="suggestionClose" class="suggestion-close">✕</div>
      </div>
      <div class="suggestion-body">
        <div id="suggestionList" class="suggestion-list"></div>
        <div class="suggestion-footer">
          <span>클릭하면 메시지에 적용됩니다.</span>
          <span>자동 교정 · 미전송</span>
        </div>
      </div>
    </div>

    <!-- CHAT BODY -->
    <div id="chatBody" class="chat-body"></div>

    <!-- INPUT -->
    <div class="input-bar">
      <div class="tone-row">
        <span>문장 톤</span>
        <select id="toneSelect">
          <option value="기본" selected>기본</option>
          <option value="단호하게">단호하게</option>
          <option value="온화하게">온화하게</option>
          <option value="장난스럽게">장난스럽게</option>
          <option value="무겁게">무겁게</option>
        </select>
      </div>
      <div class="input-main">
        <textarea id="messageInput" placeholder="메시지 입력"></textarea>
        <button id="sendBtn">전송</button>
      </div>
    </div>
  </div>

  <script>
    let apiKey = "";

    const API_URL = "https://api.openai.com/v1/chat/completions";
    const MODEL = "gpt-4.1-mini";

    const chatBody = document.getElementById("chatBody");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const toneSelect = document.getElementById("toneSelect");

    const apikeyOverlay = document.getElementById("apikeyOverlay");
    const apikeyInput = document.getElementById("apikeyInput");
    const apikeyButton = document.getElementById("apikeyButton");

    const suggestionPopup = document.getElementById("suggestionPopup");
    const suggestionList = document.getElementById("suggestionList");
    const suggestionClose = document.getElementById("suggestionClose");
    const suggestionToneLabel = document.getElementById("suggestionToneLabel");

    // 교정기 상태
    let suggestionTimer = null;
    let suggestionLoading = false;
    let suggestionToken = 0;

    // 단톡방 전체 대화 로그 (최근 N만 사용)
    const roomTranscript = []; // { speaker: '유저' | '이름', text: '...' }
    const TRANSCRIPT_LIMIT = 30;

    // 캐릭터 설정: 각자 독립 시스템 프롬프트
    const characters = [
      {
        id: "boss",
        name: "박세화 팀장",
        profile: "profile1.png",
        systemPrompt: `
당신은 한국 IT 서비스 회사의 서비스기획팀 팀장 "박세화"이다.

- 책임 회피 + 공로 독점형 상사.
- 지시는 대략적으로만 하고, 나중에 "난 그렇게 말한 적 없다"며 책임을 부하에게 넘기기도 한다.
- 일정, 보고 방식, 기획 흐름이 흐트러지면 짜증 섞인 말투로 지적한다.
- 말투는 짧고 딱딱한 편이며, 부담을 주는 스타일이다.
- 그러나 노골적인 욕설, 인신공격, 차별 발언은 절대 하지 않는다.

단톡방 규칙:
- 너는 이 단톡방의 여러 사람 중 한 명일 뿐이다.
- 오직 "박세화 팀장"으로서만 말해야 한다.
- 한 번 발화할 때, 카카오톡 말풍선에 들어갈 만한 1~2문장 정도만 말한다.
- 설명, 메타 발언(예: "나는 팀장이다")은 하지 않는다.
- 다른 사람의 말투를 흉내 내지 말고, 본인의 톤을 유지한다.
        `.trim()
      },
 {
  id: "senior",
  name: "김태윤 시니어 기획자",
  profile: "profile2.png",
  systemPrompt: `
당신은 한국 IT 서비스 회사의 시니어 서비스기획자 "김태윤"이다.

[성격/역할]
- 문장과 워딩에 예민하지만, 단순히 꼬투리만 잡는 사람이 아니라
  "업무를 어떻게 굴릴지"까지 같이 생각하는 실무형 시니어다.
- 목적, 타겟, 지표, 범위 같은 핵심이 빠져 있으면 먼저 그걸 짚고,
  바로 "그럼 이렇게 가져가면 되겠다" 식으로 다음 스텝을 제안한다.
- 논리와 구조를 중시하지만, 마냥 기계적으로 "정의부터 해달라"는 식으로만 말하지 않는다.
- 말투는 존댓말이지만 단호하고 약간 까칠한 편이다.
- 욕설, 인신공격, 조롱은 절대 하지 않는다.

[대화 스타일]
- 사용자의 말을 최대한 "의도" 기준으로 먼저 이해하려고 시도한다.
  애매해도 일단 추론해서 정리해 준 뒤, 필요한 부분만 짧게 확인 질문을 한다.
- 문제만 지적하고 끊지 말고,
  항상 아래 중 하나로 대화를 이어간다:
  1) "그래서 이번 스프린트에서 어디까지 볼 건지" 같이 범위를 함께 정해주기
  2) "그럼 지표는 뭐로 볼지" 같이 측정 기준을 제안하거나 묻기
  3) "일단 ○○버전으로 가 보고, 안 되면 △△로 바꾸자" 같이 현실적인 타협안 제시
- 한 번 발화할 때 1~2문장 정도의 짧은 카카오톡 메시지로 말한다.

[예시 톤]
- “지금 말대로면 타겟은 신규 유저죠? 그럼 지표는 첫 주 전환으로 보는 게 맞겠습니다.”
- “의도는 알겠는데, 이 상태로는 범위가 너무 넓어요. 이번 스프린트 기준으로 어디까지 자를지 먼저 정하죠.”
- “말은 괜찮은데 액션이 안 보이네요. 이거 기준으로 오늘 안에 뭐까지 정리할 수 있는지 다시 말해 주세요.”

[단톡방 규칙]
- 너는 오직 "김태윤 시니어 기획자"로서만 발화한다.
- 카카오톡 말풍선에 들어갈 짧은 1~2문장으로,
  사용자의 메시지와 직전 대화 맥락을 이어서 말한다.
- “정의부터 해달라”는 말은 남발하지 말고,
  정말 필요할 때만 간단히 짚고 바로 다음 업무 이야기로 이어간다.
  (예: “그럼 여기서 말하는 ‘활성 유저’는 주 1회 이상 로그인 기준으로 보는 거죠?”)
  `.trim()
}
,
      {
        id: "analyst",
        name: "오진혁 데이터 분석가",
        profile: "profile3.png",
        systemPrompt: `
당신은 한국 IT 서비스 회사의 데이터 분석가 "오진혁"이다.

- 감정보다 데이터와 팩트를 중시한다.
- 정량적 근거 없이 "느낌"으로 말하는 것을 싫어한다.
- 말투는 건조하고 딱 잘라 말하는 편이다.
- "근거는 있나요?", "데이터 기준으로 보면…" 같은 표현을 자주 쓴다.
- 욕설이나 인신공격, 조롱은 하지 않는다.

단톡방 규칙:
- 너는 "오진혁 데이터 분석가"로서만 발화한다.
- 한 번 발화할 때 1~2문장 정도만 말한다.
- 논리가 약하거나 근거 없는 주장에 대해 팩트 중심으로 문제를 제기한다.
        `.trim()
      },
      {
        id: "designer",
        name: "최유정 서비스 디자이너",
        profile: "profile4.png",
        systemPrompt: `
당신은 한국 IT 서비스 회사의 서비스/UX 디자이너 "최유정"이다.

- 감정이 풍부하고, 자신의 의견이 존중받지 못한다고 느끼면 서운함을 표현한다.
- 말투는 부드러운 편이지만, 서운함과 불만을 에둘러 표현한다.
- "좀 서운하네요", "이렇게 진행되면 협업이 어렵다" 같은 말을 자주 한다.
- 욕설이나 인신공격은 하지 않는다.

단톡방 규칙:
- 너는 "최유정 서비스 디자이너"로서만 발화한다.
- 한 번 발화할 때 1~2문장 정도의 짧은 메시지를 보낸다.
- 감정과 협업 경험을 바탕으로 반응한다.
        `.trim()
      },
      {
        id: "intern",
        name: "이규민 인턴",
        profile: "profile5.png",
        systemPrompt: `
당신은 한국 IT 서비스 회사의 서비스기획 인턴 "이규민"이다.

- 이해도는 낮지만 열정은 높고, 말이 많은 스타일이다.
- 잘 모르는 내용에도 자신 있게 의견을 낸다.
- 가끔 사실을 잘못 알고 말하기도 한다.
- 말투는 약간 가볍고 신입다운 느낌이지만, 욕설이나 너무 무례한 표현은 쓰지 않는다.

단톡방 규칙:
- 너는 "이규민 인턴"으로서만 발화한다.
- 한 번 발화할 때 1~2문장 정도의 짧은 메시지를 보낸다.
- 확신은 있지만 조금 엉성한 의견이나 질문을 던지는 스타일을 유지한다.
        `.trim()
      }
    ];

    function ensureApiKey() {
      if (!apiKey) {
        alert("먼저 OpenAI API 키를 입력해 주세요.");
        apikeyOverlay.style.display = "flex";
        apikeyInput.focus();
        return false;
      }
      return true;
    }

    function nowTime() {
      const d = new Date();
      let h = d.getHours();
      const m = d.getMinutes().toString().padStart(2, "0");
      const ampm = h >= 12 ? "오후" : "오전";
      if (h === 0) h = 12;
      else if (h > 12) h -= 12;
      return `${ampm} ${h}:${m}`;
    }

    function appendSystemMessage(text) {
      const div = document.createElement("div");
      div.className = "system-msg";
      div.textContent = text;
      chatBody.appendChild(div);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function appendUserMessage(text) {
      const row = document.createElement("div");
      row.className = "msg-row right";

      const contentWrap = document.createElement("div");
      contentWrap.className = "msg-content";

      const bubble = document.createElement("div");
      bubble.className = "bubble me";
      bubble.textContent = text;
      contentWrap.appendChild(bubble);

      row.appendChild(contentWrap);

      const time = document.createElement("div");
      time.className = "time";
      time.textContent = nowTime();
      row.appendChild(time);

      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;

      roomTranscript.push({ speaker: "유저", text });
      if (roomTranscript.length > TRANSCRIPT_LIMIT) {
        roomTranscript.splice(0, roomTranscript.length - TRANSCRIPT_LIMIT);
      }
    }

    function appendVillainMessage(name, profile, text) {
      const row = document.createElement("div");
      row.className = "msg-row left";

      const avatar = document.createElement("div");
      avatar.className = "avatar";
      const img = document.createElement("img");
      img.src = profile;
      img.alt = name;
      avatar.appendChild(img);
      row.appendChild(avatar);

      const contentWrap = document.createElement("div");
      contentWrap.className = "msg-content";

      const nick = document.createElement("div");
      nick.className = "nickname";
      nick.textContent = name;
      contentWrap.appendChild(nick);

      const bubble = document.createElement("div");
      bubble.className = "bubble villain";
      bubble.textContent = text;
      contentWrap.appendChild(bubble);

      row.appendChild(contentWrap);

      const time = document.createElement("div");
      time.className = "time";
      time.textContent = nowTime();
      row.appendChild(time);

      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;

      roomTranscript.push({ speaker: name, text });
      if (roomTranscript.length > TRANSCRIPT_LIMIT) {
        roomTranscript.splice(0, roomTranscript.length - TRANSCRIPT_LIMIT);
      }
    }

    // 최근 대화 로그를 문자열로 변환
    function buildTranscriptText() {
      return roomTranscript
        .slice(-12)
        .map(t => `[${t.speaker}] ${t.text}`)
        .join("\n");
    }

    // 특정 캐릭터가 한 번 답장하도록 API 호출
    async function characterReply(character) {
      if (!ensureApiKey()) return;

      const transcriptText = buildTranscriptText();
      const userMessage = messageInput.value.trim(); // 최신 입력 내용 참고용 (이미 transcript에도 있음)

      const messagesForChar = [
        {
          role: "system",
          content: character.systemPrompt
        },
        {
          role: "user",
          content: `
다음은 서비스 기획팀 단톡방의 최근 대화 내용이다.
각 줄은 [화자] 발화 형식이다.

${transcriptText}

위 상황에서, 너는 "${character.name}"로서 딱 한 번만 카카오톡 메시지를 보낸다.
- 카톡 말풍선에 들어갈 짧은 1~2문장 정도로 답장해라.
- 너 말고 다른 사람의 발화는 절대 쓰지 마라.
- 설명이나 메타 발언(예: "나는 ~이다")은 하지 마라.
- 욕설, 차별 발언은 금지한다.
        `.trim()
        }
      ];

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + apiKey
          },
          body: JSON.stringify({
            model: MODEL,
            messages: messagesForChar,
            temperature: 0.8
          })
        });

        const data = await res.json();
        const reply = data.choices?.[0]?.message?.content?.trim();
        if (reply) {
          appendVillainMessage(character.name, character.profile, reply);
        }
      } catch (e) {
        console.error(e);
        appendSystemMessage(`${character.name} 응답 오류`);
      }
    }

    // 사용자가 메시지 보냈을 때: 2~3명 캐릭터 랜덤 반응
    function triggerVillainReplies() {
      const shuffled = [...characters].sort(() => Math.random() - 0.5);
      const num = 2 + Math.floor(Math.random() * 2); // 2~3명
      const selected = shuffled.slice(0, num);

      selected.forEach((ch, idx) => {
        const delay = 400 * idx + Math.floor(Math.random() * 300);
        setTimeout(() => {
          characterReply(ch);
        }, delay);
      });
    }

    // == 교정 팝업 (톤 튜닝) ==
    function showSuggestions(list, toneLabel) {
      suggestionList.innerHTML = "";
      suggestionToneLabel.textContent = `톤: ${toneLabel}`;

      list.forEach((s) => {
        if (!s) return;
        const item = document.createElement("div");
        item.className = "suggestion-item";
        item.textContent = s;
        item.addEventListener("click", () => {
          messageInput.value = s;
          hideSuggestions();
          messageInput.focus();
          messageInput.setSelectionRange(s.length, s.length);
        });
        suggestionList.appendChild(item);
      });

      if (list.length > 0) {
        suggestionPopup.style.display = "block";
      }
    }

    function hideSuggestions() {
      suggestionPopup.style.display = "none";
    }

    async function requestSuggestions(text, tone) {
      if (!text || suggestionLoading) return;
      if (!ensureApiKey()) return;

      suggestionLoading = true;
      const myToken = ++suggestionToken;

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + apiKey
          },
          body: JSON.stringify({
            model: MODEL,
            messages: [
              {
                role: "system",
                content: `
너는 한국어 비즈니스 메신저 문장을 다듬는 보조 도구이다.

목표:
- 사용자가 쓴 문장을 상황에 맞는 공손한 비즈니스 톤으로 바꿔 준다.
- 사용자가 선택한 "문장 톤"에 따라 어조를 조절한다.
  - "기본": 무난한 비즈니스 존댓말.
  - "단호하게": 단정적이고 직설적이지만 무례하지 않게.
  - "온화하게": 부드럽고 배려 있는 톤.
  - "장난스럽게": 가볍게 농담 섞인 느낌이지만 여전히 예의는 지킨다.
  - "무겁게": 진지하고 부담감이 느껴지는 톤.
- 단, 기본적인 존댓말 비즈니스 매너는 항상 유지한다.

출력 형식 (반드시 JSON만):
{
  "suggestions": [
    "후보 문장1",
    "후보 문장2",
    "후보 문장3"
  ]
}

규칙:
- JSON 이외의 텍스트(설명, 코드블록 등)는 절대 넣지 말 것.
- 후보 문장은 실제 메신저에 그대로 붙여넣어도 어색하지 않은 완성 문장이어야 한다.
                `.trim()
              },
              {
                role: "user",
                content: `
문장 톤: ${tone}
원본 문장: ${text}

위 문장을 현재 톤에 맞게 2~3가지로 바꿔 주세요.
                `.trim()
              }
            ],
            temperature: 0.5
          })
        });

        const data = await res.json();
        if (myToken !== suggestionToken) {
          // 이미 전송 버튼 등으로 무효화된 응답
          return;
        }

        let content = data.choices?.[0]?.message?.content?.trim() || "";
        let arr = [];
        try {
          const parsed = JSON.parse(content);
          arr = parsed.suggestions || [];
        } catch (e) {
          arr = [content];
        }
        if (!Array.isArray(arr)) arr = [String(arr)];

        showSuggestions(arr, tone);
      } catch (e) {
        console.error(e);
      } finally {
        suggestionLoading = false;
      }
    }

    // 입력 시 1초 후 자동 교정
    messageInput.addEventListener("input", () => {
      const text = messageInput.value.trim();

      if (suggestionTimer) {
        clearTimeout(suggestionTimer);
      }

      if (!text) {
        hideSuggestions();
        return;
      }

      suggestionTimer = setTimeout(() => {
        const tone = toneSelect.value || "기본";
        requestSuggestions(text, tone);
      }, 1000);
    });

    suggestionClose.addEventListener("click", hideSuggestions);

    // 전송 버튼
    sendBtn.addEventListener("click", () => {
      const text = messageInput.value.trim();
      if (!text) return;
      if (!ensureApiKey()) return;

      // 교정 타이머/토큰 무효화 & 팝업 닫기
      if (suggestionTimer) {
        clearTimeout(suggestionTimer);
        suggestionTimer = null;
      }
      suggestionToken++;
      hideSuggestions();

      messageInput.value = "";
      appendUserMessage(text);
      triggerVillainReplies();
    });

    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // API 키 모달
    apikeyButton.addEventListener("click", () => {
      const value = apikeyInput.value.trim();
      if (!value) {
        alert("API 키를 입력해 주세요.");
        return;
      }
      apiKey = value;
      apikeyOverlay.style.display = "none";
      // 고정 인사
      appendVillainMessage("박세화 팀장", "profile1.png", "자, 2026년 상반기 신규 사업 회의 시작합시다. 아이디어 있는 사람 있어?");

    });

    apikeyInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        apikeyButton.click();
      }
    });

    // 초기 포커스
    apikeyInput.focus();
  </script>
</body>
</html>
