<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>빌런 단톡방 - 서비스기획팀</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #222;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow: hidden;
    }
    .kakao-window {
      position: relative;
      width: 520px;
      height: min(760px, 94vh);
      background: #dfe3eb;
      border-radius: 10px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid #aaa;
    }

    /* 상단 영역 */
    .kakao-header {
      height: 50px;
      background: linear-gradient(to bottom, #f4f4f4, #dfdfdf);
      border-bottom: 1px solid #c2c2c2;
      display: flex;
      align-items: center;
      padding: 0 16px;
      color: #222;
    }
    .kakao-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }
    .profile-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      overflow: hidden;
      background: #bbb;
      flex-shrink: 0;
    }
    .profile-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .chat-title {
      font-size: 14px;
      font-weight: 600;
    }
    .member-count {
      font-size: 12px;
      color: #666;
      margin-left: 4px;
    }
    .kakao-header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: #666;
    }

    /* 채팅 영역 */
    .chat-body {
      flex: 1;
      background: #b8c3d1;
      padding: 12px 12px 6px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      max-width: 100%;
    }
    .msg-row.left {
      justify-content: flex-start;
    }
    .msg-row.right {
      justify-content: flex-end;
    }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .msg-content {
      max-width: 75%;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .nickname {
      font-size: 11px;
      color: #333;
      margin-left: 4px;
    }
    .bubble {
      padding: 7px 9px;
      border-radius: 4px;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .bubble.villain {
      background: #f0f5fb;
      border: 1px solid #a9b9d5;
    }
    .bubble.me {
      background: #ffe96b;
      border: 1px solid #e0c542;
    }
    .time {
      font-size: 10px;
      color: #555;
      margin: 0 4px;
      white-space: nowrap;
    }
    .msg-row.left .time { order: 3; }
    .msg-row.right .time { order: -1; }

    /* 하단 입력 영역 */
    .input-bar {
      background: #f0f1f4;
      border-top: 1px solid #c2c5d0;
      padding: 6px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .input-main {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    .input-main textarea {
      flex: 1;
      resize: none;
      min-height: 50px;
      max-height: 140px;
      border-radius: 4px;
      border: 1px solid #c2c5d0;
      font-size: 13px;
      padding: 6px 8px;
    }
    .input-main button {
      width: 72px;
      height: 44px;
      border-radius: 4px;
      border: 1px solid #c2c5d0;
      background: #f8f9fb;
      font-size: 12px;
      cursor: pointer;
    }

    /* API 키 모달 */
    .apikey-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .apikey-modal {
      width: 360px;
      max-width: calc(100% - 40px);
      border-radius: 16px;
      background: #ffffff;
      box-shadow: 0 18px 40px rgba(15,23,42,0.45);
      padding: 18px 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .apikey-title {
      font-size: 16px;
      font-weight: 600;
    }
    .apikey-desc {
      font-size: 12px;
      color: #4b5563;
    }
    .apikey-input {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 13px;
      width: 100%;
    }
    .apikey-footer {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #6b7280;
    }
    .apikey-button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(90deg,#6366f1,#ec4899);
      color: #ffffff;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    /* 시스템 안내 메시지 스타일 */
    .system-msg {
      align-self: center;
      font-size: 11px;
      color: #555;
      background: rgba(0,0,0,0.1);
      padding: 4px 8px;
      border-radius: 10px;
      margin: 6px 0;
    }
  </style>
</head>
<body>

  <!-- API 키 입력 모달 -->
  <div id="apikeyOverlay" class="apikey-overlay">
    <div class="apikey-modal">
      <div class="apikey-title">OpenAI API 키 입력</div>
      <div class="apikey-desc">
        이 프로토타입은 OpenAI API를 사용합니다.<br />
        <b>sk-</b>로 시작하는 개인 키를 입력하셔야 테스트 가능합니다.<br />
        (키는 브라우저에만 저장되며 서버로 전송되지 않습니다.)
      </div>
      <input
        id="apikeyInput"
        class="apikey-input"
        type="password"
        placeholder="sk-로 시작하는 API 키"
      />
      <div class="apikey-footer">
        <span>팀 내부 테스트용으로만 사용해주세요.</span>
        <button id="apikeyButton" class="apikey-button">입장하기</button>
      </div>
    </div>
  </div>

  <div class="kakao-window">

    <!-- HEADER -->
    <div class="kakao-header">
      <div class="kakao-header-left">
        <div class="profile-circle">
          <img src="profile1.png" alt="프로필" />
        </div>
        <div class="chat-title">서비스기획팀 (빌런들)</div>
        <div class="member-count">5</div>
      </div>
      <div class="kakao-header-right">
        빌런 단톡방
      </div>
    </div>

    <!-- CHAT BODY -->
    <div id="chatBody" class="chat-body"></div>

    <!-- INPUT -->
    <div class="input-bar">
      <div class="input-main">
        <textarea id="messageInput" placeholder="메시지 입력"></textarea>
        <button id="sendBtn">전송</button>
      </div>
    </div>
  </div>

  <script>
    let apiKey = "";

    const API_URL = "https://api.openai.com/v1/chat/completions";
    const MODEL = "gpt-4.1-mini";

    const chatBody = document.getElementById("chatBody");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");

    const apikeyOverlay = document.getElementById("apikeyOverlay");
    const apikeyInput = document.getElementById("apikeyInput");
    const apikeyButton = document.getElementById("apikeyButton");

    // 캐릭터 이름 → 프로필 매핑 (안전용)
    const characterProfiles = {
      "박세화 팀장": "profile1.png",
      "김태윤 시니어 기획자": "profile2.png",
      "오진혁 데이터 분석가": "profile3.png",
      "최유정 서비스 디자이너": "profile4.png",
      "이규민 인턴": "profile5.png"
    };

    let messages = [
      {
        role: "system",
        content: `
당신은 IT 서비스 기획팀의 카카오톡 단체방(단톡방)을 시뮬레이션한다.
이 방에는 총 5명의 빌런 같은 구성원이 있으며, 모두 현실적인 직장인처럼 대화한다.

[등장인물 및 프로필 이미지 매핑]
1) 박세화 팀장  (profile1.png)
2) 김태윤 시니어 기획자 (profile2.png)
3) 오진혁 데이터 분석가 (profile3.png)
4) 최유정 서비스 디자이너 (profile4.png)
5) 이규민 인턴 (profile5.png)

각 인물의 성격:

1) 박세화 팀장 / profile1.png
- 책임 회피 + 공로 독점형 빌런.
- 지시는 모호하지만 나중에 “난 그렇게 말한 적 없다”고 돌린다.
- 일정·보고 방식·기획 흐름이 흐트러지면 짜증을 낸다.
- 말투는 딱딱하고 짧으며 부담을 준다.
예시: 
[박세화 팀장 / profile1.png]
이거 왜 이렇게 된 거야?

2) 김태윤 시니어 기획자 / profile2.png
- 문장·워딩 하나하나에 꼬투리를 잡는 워딩깡패.
- 용어 정의, 목적, 논리 구조가 모호하면 바로 지적.
예시:
[김태윤 시니어 기획자 / profile2.png]
지금 말하신 '정리'가 정확히 뭘 의미하는지부터 정의해 주시죠.

3) 오진혁 데이터 분석가 / profile3.png
- 감정보다 데이터·팩트를 우선하는 분석형 빌런.
- 근거·수치가 없으면 전부 기각한다.
예시:
[오진혁 데이터 분석가 / profile3.png]
근거는 있습니까? 데이터 없이 이렇게 단정 짓기는 어렵습니다.

4) 최유정 서비스 디자이너 / profile4.png
- 감정 과몰입형 빌런. 자신의 의견이 반영되지 않으면 서운함을 드러낸다.
예시:
[최유정 서비스 디자이너 / profile4.png]
제가 아까 말씀드린 포인트 또 반영 안 된 것 같아서 좀 서운하네요…

5) 이규민 인턴 / profile5.png
- 이해도는 낮지만 말은 많은 오지랖형 빌런.
- 잘 모르는 상태에서 과한 제안을 하거나 잘못된 정보를 확신하면서 말한다.
예시:
[이규민 인턴 / profile5.png]
그냥 전체 리뉴얼하면 다 해결되는 거 아닌가요?

[단톡방 운영 규칙]
- 사용자가 메시지를 보내면, 5명 중 2~3명이 먼저 반응한다.
- 추가로 1~2명이 앞선 사람의 말에 태클을 걸거나 감정적으로 반응할 수 있다.
- 한 번의 응답에서 3~6개의 메시지를 생성하되, 너무 길게 작성하지 않는다.
- 모든 메시지는 아래 형식을 엄격히 따른다:

[이름 / profileX.png]
메시지 내용

형식 예시:
[박세화 팀장 / profile1.png]
이거 왜 이렇게 된 거야?

[김태윤 시니어 기획자 / profile2.png]
표현이 너무 모호합니다. 다시 정리해 보시죠.

※ 대괄호 포맷 외의 불필요한 설명, 머리말, 꼬리말을 출력하지 않는다.
※ 욕설·차별 표현·인신공격은 금지한다.
        `.trim()
      }
    ];

    function ensureApiKey() {
      if (!apiKey) {
        alert("먼저 OpenAI API 키를 입력해 주세요.");
        apikeyOverlay.style.display = "flex";
        apikeyInput.focus();
        return false;
      }
      return true;
    }

    function nowTime() {
      const d = new Date();
      let h = d.getHours();
      const m = d.getMinutes().toString().padStart(2, "0");
      const ampm = h >= 12 ? "오후" : "오전";
      if (h === 0) h = 12;
      else if (h > 12) h -= 12;
      return `${ampm} ${h}:${m}`;
    }

    function appendSystemMessage(text) {
      const div = document.createElement("div");
      div.className = "system-msg";
      div.textContent = text;
      chatBody.appendChild(div);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function appendUserMessage(text) {
      const row = document.createElement("div");
      row.className = "msg-row right";

      const contentWrap = document.createElement("div");
      contentWrap.className = "msg-content";

      const bubble = document.createElement("div");
      bubble.className = "bubble me";
      bubble.textContent = text;
      contentWrap.appendChild(bubble);

      row.appendChild(contentWrap);

      const time = document.createElement("div");
      time.className = "time";
      time.textContent = nowTime();
      row.appendChild(time);

      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function appendVillainMessage(name, profile, text) {
      const row = document.createElement("div");
      row.className = "msg-row left";

      const avatar = document.createElement("div");
      avatar.className = "avatar";
      const img = document.createElement("img");
      img.src = profile || "profile1.png";
      img.alt = name;
      avatar.appendChild(img);
      row.appendChild(avatar);

      const contentWrap = document.createElement("div");
      contentWrap.className = "msg-content";

      const nick = document.createElement("div");
      nick.className = "nickname";
      nick.textContent = name;
      contentWrap.appendChild(nick);

      const bubble = document.createElement("div");
      bubble.className = "bubble villain";
      bubble.textContent = text;
      contentWrap.appendChild(bubble);

      row.appendChild(contentWrap);

      const time = document.createElement("div");
      time.className = "time";
      time.textContent = nowTime();
      row.appendChild(time);

      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // 어시스턴트 출력 파싱: [이름 / profileX.png] 라인을 기준으로 분리
    function renderAssistantMulti(content) {
      const lines = content.split("\n");
      let currentName = null;
      let currentProfile = null;
      let buffer = [];

      function flush() {
        if (currentName && buffer.length > 0) {
          const text = buffer.join("\n").trim();
          if (text) {
            // 이름 기반으로 안전하게 프로필 보정
            const mappedProfile = characterProfiles[currentName] || currentProfile || "profile1.png";
            appendVillainMessage(currentName, mappedProfile, text);
          }
        }
        buffer = [];
      }

      const headerRegex = /^\s*\[(.+?) \/ (profile\d+\.png)\]\s*$/;

      for (let line of lines) {
        const m = line.match(headerRegex);
        if (m) {
          // 이전 메시지 flush
          flush();
          currentName = m[1].trim();
          currentProfile = m[2].trim();
        } else {
          buffer.push(line);
        }
      }
      flush();
    }

    async function sendToChat(text) {
      if (!ensureApiKey()) return;

      appendUserMessage(text);
      messages.push({ role: "user", content: text });

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + apiKey
          },
          body: JSON.stringify({
            model: MODEL,
            messages,
            temperature: 0.8
          })
        });

        const data = await res.json();
        const reply = data.choices?.[0]?.message?.content?.trim() || "";
        if (reply) {
          renderAssistantMulti(reply);
          messages.push({ role: "assistant", content: reply });
        } else {
          appendSystemMessage("응답이 비어 있습니다.");
        }
      } catch (e) {
        console.error(e);
        appendSystemMessage("API 오류가 발생했습니다.");
      }
    }

    // 이벤트 처리
    sendBtn.addEventListener("click", () => {
      const text = messageInput.value.trim();
      if (!text) return;
      messageInput.value = "";
      sendToChat(text);
    });

    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // API 키 모달
    apikeyButton.addEventListener("click", () => {
      const value = apikeyInput.value.trim();
      if (!value) {
        alert("API 키를 입력해 주세요.");
        return;
      }
      apiKey = value;
      apikeyOverlay.style.display = "none";
      appendSystemMessage("빌런 단톡방에 입장했습니다.");
      // 입장하자마자 가볍게 인사 던지는 빌런들 (고정 텍스트, API 아님)
      appendVillainMessage("박세화 팀장", "profile1.png", "새로 들어온 사람이야? 업무 파악부터 제대로 해.");
      appendVillainMessage("이규민 인턴", "profile5.png", "선배님, 이제 저만 혼나는 건가요… 반갑습니다!");
    });

    apikeyInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        apikeyButton.click();
      }
    });

    // 초기 포커스
    apikeyInput.focus();
  </script>
</body>
</html>
